---
# tasks file for infra_server_kvm_ansible_bootstrap

# Create VM Directory
- name: Create VM Keys Directory
  file:
    path: "{{ vm_keys_dir }}"
    state: directory
    mode: 0755

# Create create-user.sh script for ansible user
- name: Create create-user.sh script for ansible user
  template:
    src: create-user.sh.j2
    dest: "/tmp/create-user.sh"

# Create ansible user ssh key pair
- name: Create ansible user ssh key pair
  openssh_keypair:
    path: "{{ vm_keys_dir }}/id_{{ vm_ansible_user }}"
    comment: Ansible Key

# Set root disk filepath list to empty
- name: Set root disk filepath list to empty
  set_fact:
    vm_root_disk_filepaths: []

# Make sure the vms are shutdown
# Shutdown the VM
- name: Shutdown the VM
  virt:
    name: "{{ item }}"
    state: shutdown
  loop: "{{ vm_names }}"

# Populate root disk filepath list 
- name: Populate root disk filepath list 
  set_fact:
    vm_root_disk_filepaths: "{{ vm_root_disk_filepaths }} + [ '{{ vm_root_dir }}/{{ item }}_{{ vm_root_disk_device }}.{{ vm_root_disk_device_format }}' ]"
  loop: "{{ vm_names }}"

# Create ansible user, set user password and inject ssh-key
- name: Create ansible user
  command: virt-customize -a {{ item }} --run /tmp/create-user.sh
  loop: "{{ vm_root_disk_filepaths }}"

- name: Set password for ansible user
  command: virt-customize -a {{ item }} --password {{ vm_ansible_user }}:password:{{ vm_ansible_password }} --ssh-inject {{ vm_ansible_user }}:file:{{ vm_keys_dir }}/id_{{ vm_ansible_user }}.pub
  loop: "{{ vm_root_disk_filepaths }}"
 
# Relabel FS
- name: Relabel FS
  command: virt-customize -a {{ item }} --selinux-relabel
  loop: "{{ vm_root_disk_filepaths }}"